// Prisma Schema for AI Council Portal
// Database: PostgreSQL
// This is the initial schema with User model
// Will be expanded in Phase 1 with sessions, and Phase 2+ with agents, memories, etc.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== Enums ====================

enum SubscriptionTier {
  FREE
  PRO
  BUSINESS
}

enum CouncilStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

enum MessageRole {
  USER
  AGENT
  SYSTEM
}

// ==================== User Management ====================

model User {
  id               String           @id @default(uuid())
  email            String           @unique
  name             String?          // Optional name field
  password         String           // Hashed with bcrypt
  subscriptionTier SubscriptionTier @default(FREE)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  sessions Session[]
  councils Council[] // Phase 3: Active
  memories Memory[] // Phase 4: Active

  @@map("users")
}

// ==================== Session Management (Phase 1) ====================

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ==================== Council Session (Phase 3) ====================

model Council {
  id          String        @id @default(uuid())
  userId      String
  name        String        // e.g. "Learn Python Council"
  description String        @db.Text // User's original goal

  // The 4 agents in this council
  agent1Id String // e.g. "agent-coder"
  agent2Id String
  agent3Id String
  agent4Id String

  // Optional: Custom agent instructions (override default system prompt)
  agent1Custom String? @db.Text
  agent2Custom String? @db.Text
  agent3Custom String? @db.Text
  agent4Custom String? @db.Text

  status CouncilStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]
  memories Memory[] // Phase 4: Memories can be linked to councils

  @@index([userId])
  @@index([status])
  @@map("councils")
}

model Message {
  id         String      @id @default(uuid())
  councilId  String
  role       MessageRole
  agentId    String? // null if role=USER or role=SYSTEM
  content    String      @db.Text

  // Usage tracking (for AGENT messages)
  tokensUsed Int?
  cost       Float? // in dollars

  createdAt DateTime @default(now())

  // Relations
  council Council @relation(fields: [councilId], references: [id], onDelete: Cascade)

  @@index([councilId])
  @@index([createdAt])
  @@map("messages")
}

// ==================== Shared Memory System (Phase 4) ====================

model Memory {
  id         String   @id @default(uuid())
  userId     String   // ðŸ”’ SECURITY: CRITICAL - Always filter by this!
  councilId  String?  // Optional: Associate with specific council
  content    String   @db.Text
  embedding  Float[]  // pgvector: Vector embedding for similarity search
  tags       String[] // For categorization and filtering
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations - onDelete: Cascade ensures user deletion removes their memories
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  council Council? @relation(fields: [councilId], references: [id], onDelete: Cascade)

  // ðŸ”’ SECURITY INDEXES: userId index is CRITICAL for fast, secure lookups
  @@index([userId]) // Fast filtering - EVERY query must use this!
  @@index([councilId])
  @@index([createdAt])
  @@map("memories")
}

// ==================== Future Models (Phase 5+) ====================

// model GeneratedOutput {
//   id        String   @id @default(uuid())
//   sessionId String
//   type      String   // 'document', 'code', 'image'
//   content   String   @db.Text
//   filename  String
//   createdAt DateTime @default(now())
//
//   @@map("generated_outputs")
// }
